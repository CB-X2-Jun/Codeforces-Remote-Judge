<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Codeforces 远程评测</title>
<style>
body{font-family:Arial, sans-serif; max-width:700px; margin:40px auto;}
label, input, select, textarea, button { display:block; width:100%; margin-bottom:10px; }
textarea{height:200px; font-family: monospace;}
button{padding:8px; background:#4CAF50; color:white; border:none; cursor:pointer;}
button:hover{background:#45a049;}
.result{padding:10px;border-radius:5px;margin-top:10px;}
.ac{background:#d4edda;color:#155724;}
.wa,.tle,.mle,.re,.pe,.ole,.systemerror{background:#f8d7da;color:#721c24;}
.ce{background:#fff3cd;color:#856404;}
</style>
</head>
<body>
<h2>Codeforces 远程评测</h2>
<form id="submitForm">
<label>JSESSIONID: <input name="jsessionid" type="text" required></label>
<label>用户名: <input name="username" type="text" required></label>
<label>题号: <input name="problem" type="text" required></label>
<label>语言:
<select name="language">
<option value="43">C11</option>
<option value="54">G++17</option>
<option value="89">G++20</option>
<option value="91">G++23</option>
<option value="70">PyPy 3.10</option>
<option value="31">Python 3</option>
<option value="87">Java 21</option>
</select></label>
<label>源代码:<br><textarea name="source" required></textarea></label>
<button type="submit">提交</button>
</form>

<div id="result"></div>

<script>
const form = document.getElementById('submitForm');
const resultDiv = document.getElementById('result');

form.addEventListener('submit', async e => {
    e.preventDefault();
    resultDiv.innerHTML = '提交中，请稍候...';

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        // 提交到后端 Function
        const submitResp = await fetch('/.netlify/functions/submit_code', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(data)
        });

        const respJson = await submitResp.json();
        if(respJson.error){
            resultDiv.innerHTML = `<div class="result systemerror">错误: ${respJson.error}</div>`;
            return;
        }

        const runid = respJson.runid;
        resultDiv.innerHTML = `提交成功，RunID: ${runid}<br>等待判定...`;

        // 轮询状态
        const pollStatus = async () => {
            const statusResp = await fetch(`/.netlify/functions/submit_code?username=${data.username}&problem=${data.problem}`);
            const statusJson = await statusResp.json();
            if(statusJson.verdict && statusJson.verdict.toLowerCase()!=='pending'){
                const cls = statusJson.verdict.toLowerCase();
                resultDiv.innerHTML = `<div class="result ${cls}">判定结果: ${statusJson.verdict}</div>
                <pre>${statusJson.raw || ''}</pre>`;
            } else {
                setTimeout(pollStatus, 1500);
            }
        };
        pollStatus();

    } catch(err){
        resultDiv.innerHTML = `<div class="result systemerror">网络错误: ${err}</div>`;
    }
});
</script>
</body>
</html>
